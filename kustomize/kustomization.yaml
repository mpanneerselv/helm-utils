apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base resources will be added dynamically by build script
resources: []

# Strategic merge patches for modifying existing resources
patchesStrategicMerge:
  - patches/ingester-resources.yaml
  - patches/distributor-hpa.yaml
  - patches/compactor-config.yaml

# JSON patches for precise modifications
patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: StatefulSet
      name: mimir-ingester
    path: patches/ingester-affinity.yaml

# Additional resources to include
resources:
  - resources/monitoring-servicemonitor.yaml
  - resources/custom-configmap.yaml
  - resources/network-policy.yaml

# ConfigMap generators for dynamic configuration
configMapGenerator:
  - name: mimir-custom-config
    files:
      - config/mimir-overrides.yaml
      - config/alertmanager-config.yaml
    options:
      disableNameSuffixHash: true

# Secret generators (use external secret management in production)
secretGenerator:
  - name: mimir-custom-secrets
    literals:
      - storage-access-key=placeholder
    options:
      disableNameSuffixHash: true

# Image transformations
images:
  - name: grafana/mimir
    newTag: "2.12.0"
  - name: grafana/enterprise-metrics
    newTag: "2.12.0"

# Common labels to add to all resources
commonLabels:
  app.kubernetes.io/managed-by: kustomize
  app.kubernetes.io/part-of: mimir-custom
  custom.chart/version: "0.1.0"

# Common annotations to add to all resources
commonAnnotations:
  custom.chart/build-date: "2025-01-13"
  custom.chart/source: "kustomize"

# Namespace (will be overridden by build script if needed)
namespace: mimir

# Name prefix for all resources
namePrefix: custom-

# Replica count modifications
replicas:
  - name: mimir-ingester
    count: 3
  - name: mimir-distributor
    count: 2
  - name: mimir-querier
    count: 2